<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../homecon-web-socket-object.html">
<link rel="import" href="../homecon-web-socket-sender.html">
<link rel="import" href="../homecon-edit-dialog.html">
<link rel="import" href="../folder-structure.html">

<link rel="import" href="../../style/style-scrollbar.html">

<dom-module id="states-settings">

    <template>

        <style include="iron-flex iron-flex-alignment iron-flex-factors style-scrollbar">
            :host {
                display: block;
            }
            .container {
                max-height: 400px;
                overflow-y: scroll;
            }
            paper-material{
                padding-left: 16px;
                padding-right: 16px;
                padding-bottom: 4px;
                padding-top: 4px;
                background-color: var(--secondary-background-color);
                margin-bottom: 8px;
            }
            .state {
                cursor: pointer;
            }
        </style>

        <homecon-web-socket-sender id="websocket"></homecon-web-socket-sender>

        <div class="container">
            <folder-structure paths="{{paths}}" on-path-tap="editDialog"></folder-structure>

            <!--<template is="dom-repeat" items="{{states}}" as="state">
                <paper-material class="horizontal layout center state" on-tap="editDialog">
                    <div class="path flex-2">{{state.path}}</div>
                    <div class="label flex">{{_configValue(state.config,'label')}}</div>
                </paper-material>
            </template>-->
        </div>

        <homecon-edit-dialog id="editDialog" on-save="edit">
            <h2>{{newPath}}</h2>
            <template is="dom-repeat" items="{{newConfig}}">
                <paper-input label="{{item.key}}" value="{{item.value}}"></paper-input>
            </template>
        </homecon-edit-dialog>

    </template>

    <script>
        Polymer({
            is: 'states-settings',

            properties: {
            },

            ready: function(){
                this.reload();
                this.listen(window.app, 'app-states-changed', 'reload');
            },

            reload: function(){
                this.states = window.app.states;

                var paths = [];
                var pathtostate = {};
                for(var i=0; i<this.states.length; i++){
                    paths.push(this.states[i]['path'])
                    pathtostate[this.states[i]['path']] = this.states[i];
                }
                this.paths = paths
                this.pathtostate = pathtostate
            },

            editDialog: function(e,d){
                console.log(d)
                this.editStateBoolean = true;
                var path = d.fullpath
                console.log(path)

                if(path in this.pathtostate){
                    var state = this.pathtostate[path]

                    this.newPath = state.path;
                    this.newConfig = this._configToNewConfig(state.config)

                    this.$.editDialog.open()
                }
            },

            edit: function(e){
                this.$.editDialog.close();
                var config = this._newConfigToConfig(this.newConfig)
                
                this.$.websocket.send({'event':'edit_state','path':this.newPath,'config':config});
            },

            _configValue: function(config,key){
                for(var i=0; i<config.length; i++){
                    if( config[i].key == key ){
                        return config[i].value;
                    }
                }
                return undefined;
            },

            _configToNewConfig: function(config){
                newConfig = []
                config.forEach(function(property){
                    value = property.value;
                    if(typeof value != 'string'){
                        value = JSON.stringify(value)
                    }
                    newConfig.push({'key':property.key,'value':value})
                });
                return newConfig
            },

            _newConfigToConfig: function(newconfig){
                var config = {};

                newconfig.forEach(function(property){
                    if(property.value != ''){
                        try{
                            var value = JSON.parse(property.value);
                        }
                        catch(e){
                            var value = property.value;
                        }
                        config[property.key] = value;
                    }
                });

                return config;
            },

        });
    </script>

</dom-module>
