<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../homecon-web-socket-object.html">
<link rel="import" href="../homecon-web-socket-sender.html">
<link rel="import" href="../homecon-edit-dialog.html">


<dom-module is="homecon-widget-alarm">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host{
                display: block;
                position: relative;
            }
            .alarm{
                position: relative;
                border: solid 1px;
                border-radius: 5px;
                border-color:  #2f2f2f;
                padding: 10px;
                margin-bottom: 4px;
            }
            .time{
                font-size: 45px;
                cursor: pointer;
            }
            .delete{
                position: absolute;
                top: 10px;
                right: 20px;
                color: var(--button-text-color);
            }
            paper-button{
                text-transform: none;
            }
            .edit{
                position: absolute;
                top: -10px;
                right: -10px;
                color: var(--button-text-color);
            }


        </style>
        
        <homecon-web-socket-object id="websocketObject" event="list_schedules" path="[[config.filter]]" data="{{alarms}}" auto></homecon-web-socket-object>
        <homecon-web-socket-sender id="websocket"></homecon-web-socket-sender>

        <template is="dom-repeat" items="{{alarms}}" as="alarm">
            <div class="alarm vertical layout">
                <div class="horizontal layout wrap">
                    <div class="time" on-tap="editTime">
                        {{_parseTime(alarm.value)}}
                    </div>
                    <div class="repeat">

                    </div>
                </div>
                <paper-dropdown-menu label="Action">
                    <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{path}}">
                        <template is="dom-repeat" items="{{actions}}" as="state">
                            <paper-item value="{{action.path}}">{{action.path}}</paper-item>
                        </template>
                    </paper-menu>
                </paper-dropdown-menu>
                <div class="delete">
                    <paper-icon-button icon="icons:delete" noink="true" on-tap="deleteAlarm"></paper-icon-button>
                </div>
            </div>
        </template>

        <paper-button class="button" on-tap="addAlarm" raised="true"> Add Alarm</paper-button>

        <paper-dialog id="timepickerDialog">
            Pick time
            <paper-input label="Hour" value="{{newHour}}"></paper-input>
            <paper-input label="Minute" value="{{newMinute}}"></paper-input>
            <div class="horizontal layout">
                <paper-button raised on-tap="cancelTime">Cancel</paper-button>
                <paper-button raised on-tap="saveTime">Save</paper-button>
            </div>
        </paper-dialog>


        <div class="edit" hidden="{{!edit}}">
            <paper-icon-button icon="editor:mode-edit" noink="true" on-tap="openEditDialog"></paper-icon-button>
        </div>
        
        <homecon-edit-dialog id="editDialog" on-save="save">
            <paper-input label="Label:" value="{{newLabel}}"></paper-input>
            <paper-input label="Filter:" value="{{newFilter}}"></paper-input>
            <paper-button on-tap="delete">Delete</paper-button>
        </homecon-edit-dialog>

    </template>
    <script>
        Polymer({
            is: 'homecon-widget-alarm',
            properties: {
                config: {
                    type: 'Object',
                    value: {'label':'new alarm section','filter':null},
                },
                edit: {
                    type: 'Boolean',
                    value: false
                },
                classes: {
                    type: 'String',
                    value: 'fullwidth',
                },
            },

            ready: function(){
            },

            addAlarm: function(){
                this.$.websocketObject.send()
            },

            openEditDialog: function(){
                this.set('newLabel',this.config.label);
                this.set('newFilter',this.config.filter);
                this.$.editDialog.open();
            },

            save: function(e){
                e.stopPropagation()

                this.$.editDialog.close();
                this.fire('edit-widget',{
                    'label': this.newLabel,
                    'filter':this.newFilter,
                });
            },

            delete: function(e){
                e.stopPropagation()
                this.fire('delete');
            },

            addAlarm: function(e){
                this.$.websocket.send({'event':'add_schedule', 'config': {'filter': this.config['filter']}, 'value': {'hour':0,'minute':0}});
            },

            deleteAlarm: function(e){
                alarm = e.model.__data__.alarm;
                this.$.websocket.send({'event':'delete_schedule','path':alarm.path});
            },

            editTime: function(e){
                this.editAlarm = e.model.__data__.alarm;
                value = JSON.parse(this.editAlarm.value);

                this.newHour = value['hour']
                this.newMinute = value['minute']
                this.$.timepickerDialog.open()
            },

            saveTime: function(e,d){
                this.$.timepickerDialog.close();
                console.log(this.editAlarm);

                console.log(this.newHour)
                console.log(this.newMinute)
            },

            cancelTime: function(){
                this.$.timepickerDialog.close();
            },

            _parseTime: function(value){
                var time = '';
                value = JSON.parse(value);
                if(value['hour'] != null && value['minute'] != null){
                    var hh = String(value['hour']);
                    if(value['hour'] < 10){
                        hh = '0' + hh;
                    }
                    var mm = String(value['minute']);
                    if(value['minute'] < 10){
                        mm = '0' + mm;
                    }
                    time = hh+':'+mm;
                }
                return time;
            },


        });
    </script>
</dom-module>
