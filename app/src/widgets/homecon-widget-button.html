<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../homecon-edit-dialog.html">
<link rel="import" href="../homecon-icon-select.html">
<link rel="import" href="../homecon-web-socket-sender.html">

<dom-module is="homecon-widget-button">
    <template>
        <style>
            :host{
                display: inline-block;
                position: relative;
            }
            .button {
                min-width: 250px;
                text-transform: none;
                font-size: 1.2em;
                font-weight: 700;
            }
            .edit{
                position: absolute;
                top: -10px;
                right: -10px;
                color: var(--button-text-color);
            }
        </style>
        
        <homecon-web-socket-sender id="websocket"></homecon-web-socket-sender>
        
        <paper-button class="button" raised on-tap="call">{{config.label}}</paper-button>
        
        <div class="edit" hidden="{{!edit}}">
            <paper-icon-button icon="editor:mode-edit" noink="true" on-tap="openEditDialog"></paper-icon-button>
        </div>
        
        <homecon-edit-dialog id="editDialog" on-save="save">
            <paper-input label="Label:" value="{{newLabel}}"></paper-input>
            <paper-input label="event:" value="{{newEvent}}"></paper-input>
            <paper-input label="data:" value="{{newData}}"></paper-input>
            <homecon-icon-select icon="{{newIcon}}"></homecon-icon-select>
            <paper-button on-tap="delete">Delete</paper-button>
        </homecon-edit-dialog>

    </template>
    <script>
        Polymer({
            is: 'homecon-widget-button',
            properties: {
                config: {
                    type: 'Object',
                    value: {'label':'new button','event':'','data':{},'icon':'blank'},
                },
                edit:{
                    type: 'Boolean',
                    value: false
                }
            },

            call: function(){
                var data = {'event':this.config.event}

                for(key in this.config.data){
                    data[key] = this.config.data[key]
                }
                this.$.websocket.send(data);
            },

            openEditDialog: function(){
                var configdata = this.config.data
                if( typeof configdata != 'string'){
                    configdata = JSON.stringify(configdata);
                }

                this.set('newLabel',this.config.label);
                this.set('newEvent',this.config.event);
                this.set('newData',configdata);
                this.set('newIcon',this.config.icon);
                this.$.editDialog.open();
            },

            save: function(e){
                e.stopPropagation()

                var configdata = this.newData
                try{
                    configdata = JSON.parse(configdata);
                }
                catch(e){
                }

                this.set('config.label',this.newLabel);
                this.set('config.event',this.newEvent);
                this.set('config.data',configdata);
                this.set('config.icon',this.newIcon);

                this.$.editDialog.close();
                this.fire('save',this.config);
            },

            delete: function(){
                this.fire('delete')
            },

            moveUp: function(){
                this.fire('move-up')
            },

            moveDown: function(){
                this.fire('move-down')
            }

        });
    </script>
</dom-module>
