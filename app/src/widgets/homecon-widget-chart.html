<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../homecon-web-socket-object.html">
<link rel="import" href="../homecon-edit-dialog.html">

<script src="../../bower_components/highcharts/highcharts.js"></script>

<dom-module is="homecon-widget-chart">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host{
                display: inline-block;
                position: relative;
            }
            .icon{
                width: 100%;
            }
            .edit{
                position: absolute;
                top: -10px;
                right: -10px;
                color: var(--button-text-color);
            }
            .value{
                text-align: center;
            }

        </style>
        
        <homecon-web-socket-object id="websocketObject" event="timeseries" path="[[config.path]]" data="{{data}}" auto></homecon-web-socket-object>
        <homecon-web-socket-object id="appendWebsocketObject" event="append_timeseries" path="[[config.path]]" data="{{appendData}}"></homecon-web-socket-object>

        <div id="container"></div>

        <div class="edit" hidden="{{!edit}}">
            <paper-icon-button icon="editor:mode-edit" noink="true" on-tap="openEditDialog"></paper-icon-button>
        </div>
        
        <homecon-edit-dialog id="editDialog" on-save="save">
            <paper-input label="Label:" value="{{newLabel}}"></paper-input>
            <paper-input label="Paths:" value="{{newPath}}"></paper-input>
            <paper-button on-tap="delete">Delete</paper-button>
        </homecon-edit-dialog>

    </template>
    <script>
        Polymer({
            is: 'homecon-widget-chart',
            properties: {
                config: {
                    type: 'Object',
                    value: {'label':'new chart','path':''},
                },
                edit: {
                    type: 'Boolean',
                    value: false
                },
                classes: {
                    type: 'String',
                    value: 'fullwidth',
                },
            },
            
            observers: [
                '_dataChanged(data)',
                '_appendDataChanged(appendData)',
            ],

            ready: function(){

                var container = this.$.container;
                this.chart = Highcharts.chart(container, {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: 'The title'
                    },
                    xAxis: {
                        type: 'datetime',
                        dateTimeLabelFormats: {
                            month: '%e. %b',
                            year: '%b'
                        },
                        title: {
                            text: 'xlabel'
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'ylabel'
                        },
                        min: 0
                    },
                    tooltip: {
                        headerFormat: '<b>{series.name}</b><br>',
                        pointFormat: '{point.x:%e. %b}: {point.y:.2f}'
                    },

                    plotOptions: {
                        spline: {
                            marker: {
                                enabled: true
                            }
                        }
                    },
                    series: []
                });

            },

            _dataChanged: function(data){
                var add = true;
                for(var i=0;i<this.chart.series.length;i++){
                    if(this.chart.series[i]._path == this.config.path){
                        add = false;
                        var series = this.chart.series[i];
                        break;
                    }
                }
                if(add){
                    var series = this.chart.addSeries({});

                    series._path = this.config.path;
                }

                for(var i=0;i<data.length;i++){
                    // try not to add double data
                    if( series.xData.length==0 || data[i][0]*1000 >= series.xData[series.xData.length-1] ){
                        series.addPoint([data[i][0]*1000,data[i][1]]);
                    }
                }

            },
            _appendDataChanged: function(appendData){
                console.log(appendData);
                this.push('data',appendData);
                console.log(this.data);
            },

            openEditDialog: function(){
                this.set('newLabel',this.config.label);
                this.set('newPath',this.config.path);
                this.$.editDialog.open();
            },

            save: function(e){
                e.stopPropagation()

                this.$.editDialog.close();
                this.fire('edit-widget',{
                    'label': this.newLabel,
                    'path':this.newPath,
                });
            },

            delete: function(e){
                e.stopPropagation()
                this.fire('delete')
            },

            moveUp: function(){
                this.fire('move-up')
            },

            moveDown: function(){
                this.fire('move-down')
            },

            

        });
    </script>
</dom-module>
